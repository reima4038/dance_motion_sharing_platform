# ドメインモデル定義書

本文書は、ダンスチーム向けスキルアップ・プラットフォームPoCのドメインモデルについて、議論の結果をまとめたものである。

## 1. 基本設計方針

ドメインモデルを設計するにあたり、以下の基本方針を定める。

*   **関心の分離 (Separation of Concerns)**: ドメインロジックとUIの状態管理を明確に分離する。ドメインオブジェクトは、UIの都合（再生状態、表示方法など）を知るべきではない。これにより、ドメインモデルの純粋性と再利用性を高める。

## 2. ティア2：練習動画比較ドメイン

### 2.1. 概要

インストラクターのお手本動画とメンバーの練習動画を並べて比較し、AIによる骨格推定を重畳表示する機能（ティア2）のドメインモデル。

### 2.2. ドメインオブジェクト

#### `PracticeComparison` (練習比較)
- **責務**: 比較対象となる2つの`Video`オブジェクト（お手本と練習用）のペアを表現する。
- **主な属性**:
    - `instructorVideo`: `Video` (お手本動画)
    - `practiceVideo`: `Video` (練習動画)
- **解説**: このオブジェクトは、どの動画とどの動画を比較するのか、という関係性のみを保持する。再生時間や再生/停止といった状態は持たない。

#### `Video` (動画)
- **責務**: 動画の基本的な情報と、それに関連する骨格データを保持する。
- **主な属性**:
    - `id`: 一意なID
    - `sourceUrl`: 動画ファイルのURL
    - `poseData`: `PoseData` (骨格データへの参照)

#### `PoseData` (骨格データ)
- **責務**: 1つの動画から抽出された、時系列の骨格情報全体を表現する。
- **主な属性**:
    - `frames`: `PoseFrame`のリスト

#### `PoseFrame` (骨格フレーム)
- **責務**: 特定時刻における全身の関節点の集合を表現する。
- **主な属性**:
    - `timestamp`: 動画内の時間
    - `keypoints`: `Keypoint`のリスト

#### `Keypoint` (関節点)
- **責務**: 1つの関節の位置と検出信頼度を表現する。
- **主な属性**:
    - `name`: 関節名
    - `position`: 座標(x, y)
    - `confidence`: 信頼度

### 2.3. ドメインサービス

#### `PoseSimilarityCalculator`
- **責務**: 2つの`PoseData`オブジェクトを受け取り、それらの動きの一致度（シンクロ率）を計算してスコアを返す。
- **解説**: 状態を持たないサービスとして実装する。計算ロジックが複雑になるため、`PracticeComparison`などのドメインオブジェクトからこの責務を分離することで、各オブジェクトの見通しを良く保つ。

### 2.4. 関連図

```
[UI/App層]
+--------------------+      uses      +------------------------+
| VideoPlayer        |--------------->| PracticeComparison     |
| (再生状態等を管理) |                +------------------------+
+--------------------+                        |
                                               | owns
                               +---------------+---------------+
                               |                               |
                       +-------v-------+               +-------v-------+
                       | Video         |               | Video         |
                       | (お手本)      |               | (練習)        |
                       +-------+-------+               +-------+-------+
                               |                               |
                       +-------v-------+               +-------v-------+
                       | PoseData      |               | PoseData      |
                       +---------------+               +---------------+
                               |                               |
                               +-------------------------------+
                               |
[Domain Service層]             | uses
+----------------------------+ |
| PoseSimilarityCalculator   |<-+
| (PoseDataを比較しスコア計算) |
+----------------------------+
```

---

## 3. ティア3：モーションキャプチャーレビューのドメイン

### 3.1. 概要

インストラクターが登録したモーションキャプチャーデータを、メンバーが3Dビューワー上で自由な視点から確認できる機能（ティア3）のドメインモデル。ティア2のモデルと同様に、UIの状態（カメラアングルや再生時間など）はドメインモデルから分離する方針を徹底する。

### 3.2. ドメインオブジェクト

#### `MotionReview` (モーションレビュー)
- **責務**: レビュー対象となる`MotionData`（お手本）を保持する。発展機能であるメンバーのモーションデータとの比較（機能ID 3-4）を見据え、将来的には複数の`MotionData`を保持できるように設計する。
- **主な属性**:
    - `instructorMotion`: `MotionData` (お手本モーション)
    - `practiceMotion`: `MotionData` (練習モーション、発展機能で利用)

#### `MotionData` (モーションデータ)
- **責務**: 1つのモーションキャプチャーデータ（.bvhファイルなど）の所在と、解析済みのフレームデータを保持する。ティア2の`Video`オブジェクトに相当する。
- **主な属性**:
    - `id`: 一意なID
    - `sourceUrl`: モーションキャプチャーファイルのURL
    - `format`: データ形式（例: "bvh"）
    - `frameData`: `MotionFrameData` (フレームデータへの参照)

#### `MotionFrameData` (モーションフレームデータ)
- **責務**: 1つのモーションデータから抽出された、時系列のフレーム情報全体を表現する。ティア2の`PoseData`に相当する。
- **主な属性**:
    - `frames`: `MotionFrame`のリスト

#### `MotionFrame` (モーションフレーム)
- **責務**: 特定時刻における全身の関節の回転情報の集合を表現する。ティア2の`PoseFrame`に相当する。
- **主な属性**:
    - `timestamp`: モーション内の時間
    - `jointRotations`: `JointRotation`のリスト

#### `JointRotation` (関節回転)
- **責務**: 1つの関節の回転情報を表現する。3次元空間での回転を扱うため、クォータニオン等の形式でデータを保持する。
- **主な属性**:
    - `jointName`: 関節名 (例: "Hips", "LeftShoulder")
    - `rotation`: 回転情報 (Quaternion or Euler angles)

### 3.3. 関連図

```
[UI/App層]
+--------------------+      uses      +--------------------+
| 3DModelViewer      |--------------->| MotionReview       |
| (再生、視点等を管理) |              +--------------------+
+--------------------+                        |
                                               | owns
                               +---------------+---------------+
                               |                               |
                       +-------v-------+               +-------v-------+
                       | MotionData    |               | MotionData    |
                       | (お手本)      |               | (練習)        |
                       +-------+-------+               +-------+-------+
                               |                               |
                       +-------v-------+               +-------v-------+
                       | MotionFrameData |             | MotionFrameData |
                       +---------------+               +---------------+
```
